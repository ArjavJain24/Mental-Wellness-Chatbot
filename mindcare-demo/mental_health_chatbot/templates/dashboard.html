{% extends "base.html" %}

{% block title %}Dashboard - MindCare AI{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 bg-light sidebar">
            <div class="p-3">
                <h5><i class="fas fa-user-circle me-2"></i>{{ username }}</h5>
                <hr>
                <div class="mood-tracker mb-4">
                    <h6><i class="fas fa-chart-line me-2"></i>Current Mood</h6>
                    <div id="currentMood" class="mood-display">
                        <span class="badge bg-secondary">Not detected yet</span>
                    </div>
                </div>

                <div class="quick-actions">
                    <h6><i class="fas fa-lightning-bolt me-2"></i>Quick Actions</h6>
                    <button class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="sendQuickMessage('I am feeling anxious')">
                        ðŸ˜Ÿ I'm feeling anxious
                    </button>
                    <button class="btn btn-outline-success btn-sm w-100 mb-2" onclick="sendQuickMessage('I am feeling happy')">
                        ðŸ˜Š I'm feeling good
                    </button>
                    <button class="btn btn-outline-warning btn-sm w-100 mb-2" onclick="sendQuickMessage('I am feeling stressed')">
                        ðŸ˜£ I'm stressed
                    </button>
                    <button class="btn btn-outline-info btn-sm w-100 mb-2" onclick="sendQuickMessage('I need coping strategies')">
                        ðŸ§˜ Need coping tips
                    </button>
                </div>

                <hr>

                <div class="photo-upload">
                    <h6><i class="fas fa-camera me-2"></i>Photo Analysis</h6>
                    <input type="file" id="photoInput" accept="image/*" class="form-control form-control-sm mb-2">
                    <button class="btn btn-info btn-sm w-100" onclick="uploadPhoto()">
                        <i class="fas fa-upload me-1"></i>Analyze Mood from Photo
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="col-md-9">
            <div class="chat-container">
                <div class="chat-header">
                    <h4><i class="fas fa-robot me-2"></i>MindCare AI Assistant</h4>
                    <p class="text-muted">Your personal mental wellness companion</p>
                </div>

                <div id="chatMessages" class="chat-messages">
                    <div class="message bot-message">
                        <div class="message-content">
                            <i class="fas fa-robot me-2"></i>
                            <strong>MindCare AI:</strong> Hello! I'm here to support you on your mental wellness journey. 
                            How are you feeling today? You can type a message, use the quick actions, or upload a photo for mood analysis.
                        </div>
                        <div class="message-time">Just now</div>
                    </div>
                </div>

                <div class="chat-input-container">
                    <div class="input-group">
                        <input type="text" id="messageInput" class="form-control" placeholder="Type your message here..." maxlength="500">
                        <button class="btn btn-primary" type="button" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="typing-indicator" id="typingIndicator" style="display: none;">
                        <span>MindCare AI is typing...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Photo Analysis Modal -->
<div class="modal fade" id="photoAnalysisModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-camera me-2"></i>Photo Mood Analysis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="photoAnalysisContent">
                <!-- Analysis results will be inserted here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let chatHistory = [];

// Send message function
async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();

    if (!message) return;

    // Add user message to chat
    addMessageToChat('user', message);
    input.value = '';

    // Show typing indicator
    showTypingIndicator();

    try {
        const response = await fetch('/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        });

        const data = await response.json();

        // Hide typing indicator
        hideTypingIndicator();

        if (data.response) {
            // Add bot response to chat
            addMessageToChat('bot', data.response);

            // Update current mood
            updateCurrentMood(data.mood);
        }
    } catch (error) {
        hideTypingIndicator();
        addMessageToChat('bot', 'Sorry, I encountered an error. Please try again.');
    }
}

// Quick message function
function sendQuickMessage(message) {
    document.getElementById('messageInput').value = message;
    sendMessage();
}

// Add message to chat
function addMessageToChat(sender, message) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;

    const now = new Date();
    const timeString = now.toLocaleTimeString();

    messageDiv.innerHTML = `
        <div class="message-content">
            ${sender === 'bot' ? '<i class="fas fa-robot me-2"></i><strong>MindCare AI:</strong>' : '<i class="fas fa-user me-2"></i><strong>You:</strong>'} 
            ${message}
        </div>
        <div class="message-time">${timeString}</div>
    `;

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Update current mood display
function updateCurrentMood(mood) {
    const moodDisplay = document.getElementById('currentMood');
    const moodColors = {
        'happy': 'success',
        'sad': 'primary',
        'anxious': 'warning',
        'stressed': 'danger',
        'angry': 'dark',
        'excited': 'info',
        'neutral': 'secondary',
        'depressed': 'secondary',
        'lonely': 'secondary',
        'overwhelmed': 'danger'
    };

    const color = moodColors[mood] || 'secondary';
    moodDisplay.innerHTML = `<span class="badge bg-${color}">${mood.charAt(0).toUpperCase() + mood.slice(1)}</span>`;
}

// Show/hide typing indicator
function showTypingIndicator() {
    document.getElementById('typingIndicator').style.display = 'block';
}

function hideTypingIndicator() {
    document.getElementById('typingIndicator').style.display = 'none';
}

// Photo upload function
async function uploadPhoto() {
    const photoInput = document.getElementById('photoInput');
    const file = photoInput.files[0];

    if (!file) {
        alert('Please select a photo first.');
        return;
    }

    const formData = new FormData();
    formData.append('photo', file);

    try {
        const response = await fetch('/upload_photo', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // Show analysis in modal
            showPhotoAnalysis(data.analysis, data.detected_mood);

            // Update current mood
            updateCurrentMood(data.detected_mood);

            // Add analysis to chat
            addMessageToChat('bot', `ðŸ“¸ Photo Analysis Complete! ${data.analysis}`);
        } else {
            alert('Error analyzing photo: ' + data.error);
        }
    } catch (error) {
        alert('Error uploading photo. Please try again.');
    }
}

// Show photo analysis in modal
function showPhotoAnalysis(analysis, mood) {
    const modalContent = document.getElementById('photoAnalysisContent');
    modalContent.innerHTML = `
        <div class="text-center mb-3">
            <i class="fas fa-brain fa-3x text-primary mb-3"></i>
            <h5>Analysis Complete!</h5>
        </div>
        <div class="alert alert-info">
            <strong>Analysis Results:</strong><br>
            ${analysis.replace(/\|/g, '<br><strong>').replace(/:/g, ':</strong>')}
        </div>
    `;

    const modal = new bootstrap.Modal(document.getElementById('photoAnalysisModal'));
    modal.show();
}

// Enter key to send message
document.getElementById('messageInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// Load chat history on page load
window.addEventListener('load', async function() {
    try {
        const response = await fetch('/chat_history');
        const history = await response.json();

        // Add recent messages to chat (limit to last 5 to avoid cluttering)
        history.slice(0, 5).reverse().forEach(item => {
            addMessageToChat('user', item.message);
            addMessageToChat('bot', item.response);
            if (item.mood) {
                updateCurrentMood(item.mood);
            }
        });
    } catch (error) {
        console.log('Could not load chat history');
    }
});
</script>
{% endblock %}